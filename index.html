<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- ========== [HEAD] ãƒšãƒ¼ã‚¸ã®ãƒ¡ã‚¿æƒ…å ± ========== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- ã‚¿ãƒ–ã®ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆSVGçµµæ–‡å­—ã‚’ãƒ‡ãƒ¼ã‚¿URIã§ç›´æ¥åŸ‹ã‚è¾¼ã¿ï¼‰ -->
  <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>ğŸ“Œ</text></svg>">

  <title>ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</title>

  <!-- ========== [STYLE] å…¨ä½“ã®é…è‰²ãƒ»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ========== -->
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --ink:#222; --acc:#2563eb; --mut:#6b7280; }
    body { font-family: "Hiragino Sans","Noto Sans JP",system-ui,sans-serif; background: var(--bg); color: var(--ink); margin: 24px; }
    h1 { text-align:center; margin: 8px 0 20px; }
    .wrap { max-width: 760px; margin: 0 auto; display: grid; gap: 16px; }
    .card { background: var(--card); border-radius: 16px; box-shadow: 0 6px 20px rgba(0,50,50,.06); padding: 18px; }
    .row { display: grid; grid-template-columns: 1fr auto; align-items: end; gap: 10px; margin-bottom: 12px; }
    label { font-weight: 700; font-size: 14px; }
    .val { min-width: 48px; text-align: right; font-feature-settings: "tnum"; color: var(--acc); font-weight: 700; }
    input[type="date"], select, textarea { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 10px; outline: none; background:#fff; }
    input[type="range"] { width: 100%; }
    textarea { min-height: 120px; resize: vertical; }
    .hint { color: var(--mut); font-size: 12px; margin-top: -6px; margin-bottom: 8px;}
    .btns { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    button { padding: 12px; border-radius: 12px; border: 0; font-weight: 700; cursor: pointer; }
    .primary { background: var(--acc); color: #fff; }
    .ghost { background: #e5efff; color: #1e40af; }
    .ok { color: #16a34a; margin-left: 6px; font-weight: 700; }
    .err { color: #b91c1c; margin-left: 6px; font-weight: 700; }
    .tag { display:inline-flex; align-items:center; gap:8px; font-size:12px; color:#334155; background:#eef2ff; border:1px solid #c7d2fe; padding:6px 10px; border-radius:999px;}
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; }
  </style>

  <!-- ========== [SCRIPT] LINE LIFF SDKã®èª­ã¿è¾¼ã¿ ========== -->
  <!-- å¿…ãš https ã‹ã‚‰é…ä¿¡ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆLIFFã®ä»•æ§˜ï¼‰ -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <!-- ========== [UI] ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« ========== -->
  <h1>ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</h1>

  <!-- ========== [UI] ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…¨ä½“ã®ãƒ©ãƒƒãƒ‘ ========== -->
  <div class="wrap">

    <!-- ========== [CARD] LIFFã®çŠ¶æ…‹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®è¡¨ç¤º ========== -->
    <!-- ç›®çš„ï¼šLIFFã®ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã¨LINEã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãƒ•ãƒ­ãƒ³ãƒˆã§è¦–èª -->
    <div class="card" id="who">
      <span class="tag">ğŸ”— LIFF: <span id="liffState">åˆæœŸåŒ–ä¸­â€¦</span></span>
      <div class="hint" id="profileHint" style="margin-top:8px;">LINEãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</div>
      <div class="mono" id="profileBox" style="display:none;margin-top:6px;"></div>
    </div>

    <!-- ========== [CARD] æ—¥ä»˜å…¥åŠ› ========== -->
    <!-- ç›®çš„ï¼šé¸æŠãŒãªã‘ã‚Œã°JSTã®ã€Œä»Šæ—¥ã€ã§ä¿å­˜ -->
    <div class="card">
      <div class="row">
        <label for="date">ğŸ“… æ—¥ä»˜</label>
        <input type="date" id="date" />
      </div>
      <div class="hint">æœªé¸æŠãªã‚‰ã€Œä»Šæ—¥ã€ã§ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆJSTï¼‰ã€‚</div>
    </div>

    <!-- ========== [CARD] æ•°å€¤ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç¾¤ ========== -->
    <!-- ç›®çš„ï¼šæº€è¶³åº¦ãƒ»æ°—åˆ†ãƒ»é€±é–“ã‚¹ã‚³ã‚¢ï¼ˆ0-10ï¼‰ã‚’è¨˜éŒ²ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã§ã¯satisfaction/mood/weekly_scoreï¼‰ -->
    <div class="card">
      <div class="row"><label for="energy">ğŸ’ª ä»Šæ—¥ã®è¡Œå‹•ã®æº€è¶³åº¦ï¼ˆ0ã€œ10ï¼‰</label><div class="val" id="v-energy">5</div></div>
      <input type="range" id="energy" min="0" max="10" step="1" value="5" oninput="syncValue('energy')">

      <div class="row"><label for="focus">ğŸ˜Š ä»Šæ—¥ã®æ°—åˆ†ï¼ˆ0ã€œ10ï¼‰</label><div class="val" id="v-focus">5</div></div>
      <input type="range" id="focus" min="0" max="10" step="1" value="5" oninput="syncValue('focus')">

      <div class="row"><label for="satisfaction">ğŸ¯ é€±é–“ã‚¹ã‚³ã‚¢ï¼ˆ0ã€œ10ï¼‰</label><div class="val" id="v-satisfaction">5</div></div>
      <input type="range" id="satisfaction" min="0" max="10" step="1" value="5" oninput="syncValue('satisfaction')">
      <div class="hint">LISTã¨åŒæ§˜ã€0â€“10ã®æ•´æ•°ã§è©•ä¾¡ã€‚DBã§ã¯ <code>satisfaction / mood / weekly_score</code> ã«å¯¾å¿œã€‚</div>
    </div>

    <!-- ========== [CARD] ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ + ãƒ¡ãƒ¢ ========== -->
    <!-- ç›®çš„ï¼šãã®æ—¥ã®ä¸»ãªå‡ºæ¥äº‹ã‚„ãƒ¡ãƒ¢ï¼ˆdiscoveryï¼‰ -->
    <div class="card">
      <div class="row">
        <label for="event">ğŸ·ï¸ ä¸»ãªã‚¤ãƒ™ãƒ³ãƒˆ</label>
        <select id="event">
          <option value="å‹‰å¼·">å‹‰å¼·</option>
          <option value="ä»•äº‹">ä»•äº‹</option>
          <option value="ä¼‘æ¯">ä¼‘æ¯</option>
          <option value="éŠã³">éŠã³</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>
      <label for="notes">ğŸ“ ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Š</label>
      <textarea id="notes" placeholder="ä»Šæ—¥ã®æ°—åˆ†ãƒ»æ°—ã¥ãã‚’è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„..."></textarea>
      <div class="hint">ãƒ¡ãƒ¢ã¯æœ€å¤§1000æ–‡å­—ã§é€ä¿¡ï¼ˆDBã‚«ãƒ©ãƒ : discoveryï¼‰ã€‚</div>
    </div>

    <!-- ========== [UI] ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ ========== -->
    <!-- ç›®çš„ï¼šn8nçµŒç”±ã§Supabaseä¿å­˜ / CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
    <div class="btns">
      <button class="primary" id="saveBtn" onclick="saveJournal()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜</button>
      <button class="ghost" onclick="exportCSV()">â¬‡ï¸ CSVã§ä¿å­˜</button>
    </div>

    <!-- ========== [UI] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º ========== -->
    <!-- ç›®çš„ï¼šé€ä¿¡æˆåŠŸ/å¤±æ•—ã®å³æ™‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
    <div id="status" class="card" style="display:none;"></div>
  </div>

  <!-- ========== [SCRIPT] ã‚¢ãƒ—ãƒªæœ¬ä½“ãƒ­ã‚¸ãƒƒã‚¯ ========== -->
  <script>
  /** ==============================
   *  0) è¨­å®šï¼ˆLIFF ID / Webhook URLï¼‰
   * ============================== */
  // LIFFã®IDï¼ˆLINE Developersã§ç™ºè¡Œã•ã‚ŒãŸã‚‚ã®ã«ç½®ãæ›ãˆå¯èƒ½ï¼‰
  const LIFF_ID = "2008372898-2q9qWmxv";
  // n8nã®Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆBOTã‚µãƒ¼ãƒï¼‰â€” æœ€çµ‚çš„ã« /journal ã«POST
  const WEBHOOK_URL = "https://yamasho.xvps.jp/webhook";

  /** ==============================
   *  1) LIFFå®Ÿè¡Œæ™‚ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆçŠ¶æ…‹ã‚’ä¿æŒï¼‰
   * ============================== */
  const LINE_CONTEXT = {
    isInClient: false,  // LINEã‚¢ãƒ—ãƒªå†…ã§é–‹ã„ã¦ã„ã‚‹ã‹
    isLoggedIn: false,  // LIFFãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹
    userId: "",         // LINEã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
    displayName: "",    // è¡¨ç¤ºå
    pictureUrl: "",     // ã‚¢ã‚¤ã‚³ãƒ³URL
    idToken: "",        // OpenID Connectã®IDãƒˆãƒ¼ã‚¯ãƒ³
  };

  /** ==============================
   *  2) ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ç¾¤
   * ============================== */

  // JSTã®"ä»Šæ—¥"ã‚’ YYYY-MM-DD ã§è¿”ã™ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚ºãƒ¬å¯¾ç­–ï¼‰
  function todayJST() {
    const now = new Date();
    const jst = new Date(now.getTime() - (now.getTimezoneOffset() + -540) * 60000);
    return jst.toISOString().slice(0, 10);
  }

  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ç¾åœ¨å€¤ã‚’å³ç«¯ã® .val ã«åŒæœŸè¡¨ç¤º
  function syncValue(id) {
    const map = { energy: 'v-energy', focus: 'v-focus', satisfaction: 'v-satisfaction' };
    const v = document.getElementById(id).value;
    const dispId = map[id];
    if (dispId) document.getElementById(dispId).textContent = v;
  }

  // å„ç¨®å…¥åŠ›å€¤ã®å–ã‚Šå‡ºã—ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
  const pick = (id) => document.getElementById(id).value;

  /** ==============================
   *  3) é€ä¿¡ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä½œæˆï¼ˆn8nâ†’Supabaseã¸æ¸¡ã™å½¢ï¼‰
   *  - Journalsãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ãƒ©ãƒ ã«åˆã‚ã›ã¦å‘½å
   * ============================== */
  function buildPayload() {
    const date = pick("date") || todayJST();
    const satisfaction = +pick("energy");       // ğŸ’ª æº€è¶³åº¦ (0-10)
    const mood         = +pick("focus");        // ğŸ˜Š æ°—åˆ† (0-10)
    const weekly_score = +pick("satisfaction"); // ğŸ¯ é€±é–“ã‚¹ã‚³ã‚¢ (0-10)
    const event        = pick("event");
    const notes        = pick("notes").trim();

    return {
      // ä»»æ„é …ç›®ï¼šå—ã‘å´ï¼ˆn8nï¼‰ã§created_atã¸å¯„ã›ã‚‹ã¨ãã«ä½¿ãˆã‚‹
      date,
      // ã‚¿ã‚¤ãƒˆãƒ«ã¯ä¸»ã‚¤ãƒ™ãƒ³ãƒˆã‚’çŸ­ç¸®ã—ã¦10æ–‡å­—ä»¥å†…ã«ï¼ˆDBå´ã®ãƒã‚§ãƒƒã‚¯ã«åˆã‚ã›ã‚‹ï¼‰
      title: (event || "ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«").slice(0, 10),
      // æ•°å€¤ç³»ï¼ˆDB: int 0â€“10ï¼‰
      satisfaction,
      mood,
      weekly_score,
      // ãƒ†ã‚­ã‚¹ãƒˆï¼ˆDB: discoveryï¼‰
      discovery: notes.slice(0, 1000),
      // é€ä¿¡å…ƒã®LIFFæƒ…å ±ï¼ˆn8nã§ user_id ç´ä»˜ã‘ç­‰ã«åˆ©ç”¨ï¼‰
      liff: {
        isInClient: LINE_CONTEXT.isInClient,
        isLoggedIn: LINE_CONTEXT.isLoggedIn,
        userId: LINE_CONTEXT.userId,
        displayName: LINE_CONTEXT.displayName,
      }
    };
  }

  /** ==============================
   *  4) ä¿å­˜å‡¦ç†ï¼ˆn8n Webhookã¸POSTï¼‰
   * ============================== */
  async function saveJournal() {
    const st = document.getElementById("status");
    st.style.display = "block";
    st.textContent = "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é€ä¿¡ä¸­â€¦";

    const body = buildPayload();

    try {
      const res = await fetch(`${WEBHOOK_URL}/journal`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          // idTokenãŒã‚ã‚Œã°Authorizationã«ä»˜ä¸ï¼ˆn8nã§æ¤œè¨¼å¯èƒ½ï¼‰
          ...(LINE_CONTEXT.idToken ? { "Authorization": `Bearer ${LINE_CONTEXT.idToken}` } : {}),
          // ä¾¿å®œãƒ˜ãƒƒãƒ€ï¼šn8nå´ã§ã®ãƒˆãƒ¬ãƒ¼ã‚¹/æ¤œè¨¼ã«ä½¿ç”¨
          "x-liff-user-id": LINE_CONTEXT.userId || "",
          "x-liff-client": LINE_CONTEXT.isInClient ? "1" : "0",
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) throw new Error("HTTP " + res.status);
      await res.text(); // è¿”å´æœ¬æ–‡ã¯ä½¿ã‚ãªã„ï¼ˆ200ç³»ãªã‚‰æˆåŠŸæ‰±ã„ï¼‰

      st.innerHTML = `âœ… ä¿å­˜å®Œäº† <span class="ok">OK</span>`;

      // LINEã‚¢ãƒ—ãƒªå†…ã§é–‹ã„ã¦ã„ã‚‹å ´åˆã¯è»½ã„å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
      if (liff.isInClient && liff.sendMessages) {
        try {
          await liff.sendMessages([{ type: "text", text: `ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ä¿å­˜ï¼š${body.date}` }]);
        } catch (_) { /* é€ä¿¡å¤±æ•—ã¯ç„¡è¦– */ }
      }
    } catch (e) {
      st.innerHTML = `âš ï¸ ä¿å­˜å¤±æ•— <span class="err">${e.message}</span>
        <div class="hint">n8n Webhook / LIFFã®scopeï¼ˆprofile, openidï¼‰ã¨Channelè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>`;
      console.error(e);
    }
  }

  /** ==============================
   *  5) CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
   * ============================== */
  function exportCSV() {
    const headers = ["date","satisfaction","mood","weekly_score","event","discovery","userId"];
    const p = buildPayload();
    // è¡¨ç¤ºä¸Šã®ã‚¤ãƒ™ãƒ³ãƒˆå€¤ï¼ˆtitleã®å…ƒï¼‰ã‚‚CSVã«å«ã‚ãŸã„ã®ã§eventã‚‚åãå‡ºã™
    const row = [
      p.date,
      p.satisfaction,
      p.mood,
      p.weekly_score,
      (pick("event") || ""),
      // æ”¹è¡Œã¯ã‚¹ãƒšãƒ¼ã‚¹ã«ç½®æ›
      (p.discovery || "").replace(/\n/g, " "),
      (LINE_CONTEXT.userId || "")
    ];
    const csv = headers.join(",") + "\n" + row.map((v) => {
      // CSVå®‰å…¨åŒ–ï¼šã‚«ãƒ³ãƒ/æ”¹è¡Œ/ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’å«ã‚€å ´åˆã¯å¼•ç”¨
      const s = String(v ?? "");
      return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
    }).join(",");

    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `journal_${p.date}.csv`;
    a.click();
  }

  /** ==============================
   *  6) LIFFåˆæœŸåŒ–ï¼ˆãƒ­ã‚°ã‚¤ãƒ³â†’ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ï¼‰
   * ============================== */
  async function initLiff() {
    const stateEl = document.getElementById("liffState");
    const profileBox = document.getElementById("profileBox");
    const profileHint = document.getElementById("profileHint");

    try {
      // LIFFåˆæœŸåŒ–
      await liff.init({ liffId: LIFF_ID });

      // å®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
      LINE_CONTEXT.isInClient = liff.isInClient();
      LINE_CONTEXT.isLoggedIn = liff.isLoggedIn();
      stateEl.textContent = `OK / inClient=${LINE_CONTEXT.isInClient} / loggedIn=${LINE_CONTEXT.isLoggedIn}`;

      // æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã‚ã‚Œã°LIFFãƒ­ã‚°ã‚¤ãƒ³ã¸èª˜å°ï¼ˆæˆ»ã‚Šå…ˆã¯è‡ªå‹•ï¼‰
      if (!LINE_CONTEXT.isLoggedIn) {
        liff.login({});
        return; // ã“ã“ã§ä¸€æ—¦çµ‚äº†ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã«å†åº¦èª­ã¿è¾¼ã¿ãŒã‹ã‹ã‚‹ï¼‰
      }

      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ï¼ˆscope: profile ãŒå¿…è¦ï¼‰
      try {
        const prof = await liff.getProfile();
        LINE_CONTEXT.userId = prof.userId || "";
        LINE_CONTEXT.displayName = prof.displayName || "";
        LINE_CONTEXT.pictureUrl = prof.pictureUrl || "";
      } catch (e) {
        console.warn("getProfile failed:", e);
      }

      // OpenIDã®IDãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆscope: openid ãŒå¿…è¦ï¼‰
      LINE_CONTEXT.idToken = liff.getIDToken() || "";

      // ç”»é¢è¡¨ç¤ºã®æ•´å‚™
      if (LINE_CONTEXT.userId) {
        profileBox.style.display = "block";
        profileHint.textContent = "LINEé€£æºOKã€‚ä¿å­˜æ™‚ã« userId / idToken ã‚’é€ä¿¡ã—ã¾ã™ã€‚";
        profileBox.textContent =
          `userId: ${LINE_CONTEXT.userId}\n` +
          `name  : ${LINE_CONTEXT.displayName}\n` +
          `inApp : ${LINE_CONTEXT.isInClient}\n` +
          `idToken(head): ${LINE_CONTEXT.idToken ? LINE_CONTEXT.idToken.slice(0,20)+'...' : '(none)'}`;
      }
    } catch (e) {
      stateEl.textContent = "åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼";
      console.error("LIFF init error:", e);
    }
  }

  /** ==============================
   *  7) åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒšãƒ¼ã‚¸èª­è¾¼æ™‚ï¼‰
   * ============================== */
  // æ—¥ä»˜ã®åˆæœŸå€¤ã‚’JSTã®ä»Šæ—¥ã«ã‚»ãƒƒãƒˆ
  document.getElementById("date").value = todayJST();
  // å³è‚©ã®æ•°å€¤è¡¨ç¤ºã‚’åˆæœŸå€¤ã«åŒæœŸ
  ["energy", "focus", "satisfaction"].forEach(syncValue);
  // LIFFã‚’åˆæœŸåŒ–
  initLiff();

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆHTMLã®onclickã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«ï¼‰
  window.saveJournal = saveJournal;
  window.exportCSV = exportCSV;
  </script>
</body>
</html>
