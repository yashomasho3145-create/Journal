<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>ğŸ“Œ</text></svg>">
<title>ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</title>
<style>
  :root { --bg:#f6f7fb; --card:#fff; --ink:#222; --acc:#2563eb; --mut:#6b7280; }
  body { font-family: "Hiragino Sans","Noto Sans JP",system-ui,sans-serif; background: var(--bg); color: var(--ink); margin: 24px; }
  h1 { text-align:center; margin: 8px 0 20px; }
  .wrap { max-width: 760px; margin: 0 auto; display: grid; gap: 16px; }
  .card { background: var(--card); border-radius: 16px; box-shadow: 0 6px 20px rgba(0,50,50,.06); padding: 18px; }
  .row { display: grid; grid-template-columns: 1fr auto; align-items: end; gap: 10px; margin-bottom: 12px; }
  label { font-weight: 700; font-size: 14px; }
  .val { min-width: 48px; text-align: right; font-feature-settings: "tnum"; color: var(--acc); font-weight: 700; }
  input[type="date"], select, textarea { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 10px; outline: none; }
  input[type="range"] { width: 100%; }
  .hint { color: var(--mut); font-size: 12px; margin-top: -6px; margin-bottom: 8px;}
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .btns { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  button { padding: 12px; border-radius: 12px; border: 0; font-weight: 700; cursor: pointer; }
  .primary { background: var(--acc); color: #fff; }
  .ghost { background: #e5efff; color: #1e40af; }
  .ok { color: #16a34a; margin-left: 6px; font-weight: 700; }
  .err { color: #b91c1c; margin-left: 6px; font-weight: 700; }
  .tag { display:inline-flex; align-items:center; gap:8px; font-size:12px; color:#334155; background:#eef2ff; border:1px solid #c7d2fe; padding:6px 10px; border-radius:999px;}
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
</style>
<!-- âœ… LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</h1>
  <div class="wrap">
    <div class="card" id="who">
      <span class="tag">ğŸ”— LIFF: <span id="liffState">åˆæœŸåŒ–ä¸­â€¦</span></span>
      <div class="hint" id="profileHint" style="margin-top:8px;">LINEãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</div>
      <div class="mono" id="profileBox" style="display:none;margin-top:6px;"></div>
    </div>

    <div class="card">
      <div class="row">
        <label>ğŸ“… æ—¥ä»˜</label>
        <input type="date" id="date">
      </div>
      <div class="hint">æœªé¸æŠãªã‚‰ã€Œä»Šæ—¥ã€ã§ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆJSTï¼‰ã€‚</div>
    </div>

    <div class="card">
      <div class="row"><label>ğŸ’ª ä»Šæ—¥ã®è¡Œå‹•ã®æº€è¶³åº¦ï¼ˆ1ã€œ10ï¼‰</label><div class="val" id="v-energy">5</div></div>
      <input type="range" id="energy" min="1" max="10" step="1" value="5" oninput="sync('energy')">

      <div class="row"><label>ğŸ˜Š ä»Šæ—¥ã®æ°—åˆ†ï¼ˆ1ã€œ10ï¼‰</label><div class="val" id="v-focus">5</div></div>
      <input type="range" id="focus" min="1" max="10" step="1" value="5" oninput="sync('focus')">

      <div class="row"><label>ğŸ¯ é€±é–“ã‚¹ã‚³ã‚¢ï¼ˆ1ã€œ10ï¼‰</label><div class="val" id="v-satisfaction">5</div></div>
      <input type="range" id="satisfaction" min="1" max="10" step="1" value="5" oninput="sync('satisfaction')">
    </div>

    <div class="card">
      <div class="row">
        <label>ğŸ·ï¸ ä¸»ãªã‚¤ãƒ™ãƒ³ãƒˆ</label>
        <select id="event">
          <option value="å‹‰å¼·">å‹‰å¼·</option>
          <option value="ä»•äº‹">ä»•äº‹</option>
          <option value="ä¼‘æ¯">ä¼‘æ¯</option>
          <option value="éŠã³">éŠã³</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>
      <label>ğŸ“ ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Š</label>
      <textarea id="notes" placeholder="ä»Šæ—¥ã®æ°—åˆ†ãƒ»æ°—ã¥ãã‚’è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„..."></textarea>
    </div>

    <div class="btns">
      <button class="primary" id="saveBtn" onclick="saveSheets()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜</button>
    </div>
    <div id="status" class="card" style="display:none;"></div>
  </div>

<script>
/** ====== è¨­å®š ====== */
// ğŸ” è‡ªåˆ†ã® LIFF ID ã‚’å…¥ã‚Œã¦ãã ã•ã„
const LIFF_ID = "2008372898-2q9qWmxv";
// n8n Webhookï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’åˆ©ç”¨ï¼‰
const WEBHOOK_URL = "https://yamasho.xvps.jp/webhook";

/** ====== LIFF çŠ¶æ…‹ ====== */
let LINE_CONTEXT = {
  isInClient: false,
  isLoggedIn: false,
  userId: "",
  displayName: "",
  pictureUrl: "",
  idToken: "",
};

async function initLiff(){
  const stateEl = document.getElementById("liffState");
  try {
    await liff.init({ liffId: LIFF_ID });
    LINE_CONTEXT.isInClient = liff.isInClient();
    LINE_CONTEXT.isLoggedIn = liff.isLoggedIn();
    stateEl.textContent = `OK / inClient=${LINE_CONTEXT.isInClient} / loggedIn=${LINE_CONTEXT.isLoggedIn}`;

    if (!LINE_CONTEXT.isLoggedIn) {
      liff.login({});
      return;
    }
    try {
      const prof = await liff.getProfile();
      LINE_CONTEXT.userId = prof.userId || "";
      LINE_CONTEXT.displayName = prof.displayName || "";
      LINE_CONTEXT.pictureUrl = prof.pictureUrl || "";
    } catch {}
    LINE_CONTEXT.idToken = liff.getIDToken() || "";

    const profileBox = document.getElementById("profileBox");
    const profileHint = document.getElementById("profileHint");
    if (LINE_CONTEXT.userId) {
      profileBox.style.display = "block";
      profileHint.textContent = "LINEé€£æºOKã€‚ä¿å­˜æ™‚ã« userId / idToken ã‚’é€ä¿¡ã—ã¾ã™ã€‚";
      profileBox.textContent =
        `userId: ${LINE_CONTEXT.userId}\n` +
        `name  : ${LINE_CONTEXT.displayName}\n` +
        `inApp : ${LINE_CONTEXT.isInClient}\n` +
        `idToken(head): ${LINE_CONTEXT.idToken ? LINE_CONTEXT.idToken.slice(0,20)+'...' : '(none)'}`
    }
  } catch (e) {
    stateEl.textContent = "åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼";
    console.error(e);
  }
}

/** ====== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
function todayJST() {
  const now = new Date();
  const jst = new Date(now.getTime() - (now.getTimezoneOffset()+-540)*60000);
  return jst.toISOString().slice(0,10);
}
function sync(id){
  const v = document.getElementById(id).value;
  const map = {
    energy:'v-energy', focus:'v-focus', satisfaction:'v-satisfaction',
    stress:'v-stress', condition:'v-condition', exercise:'v-exercise',
    social:'v-social', sleep_hours:'v-sleep', phone_hours:'v-phone',
    out_hours:'v-out', productive_hours:'v-prod', rest_hours:'v-rest'
  };
  const dispId = map[id];
  if (dispId) document.getElementById(dispId).textContent = v;
}
function pick(id){ return document.getElementById(id).value; }

function payload(){
  const d = document.getElementById("date").value || todayJST();
  return {
    date: d,
    sleep_hours: +pick("sleep_hours"),
    energy: +pick("energy"),
    satisfaction: +pick("satisfaction"),
    focus: +pick("focus"),
    stress: +pick("stress"),
    social: +pick("social"),
    out_hours: +pick("out_hours"),
    phone_hours: +pick("phone_hours"),
    exercise: +pick("exercise"),
    condition: +pick("condition"),
    event: pick("event"),
    productive_hours: +pick("productive_hours"),
    rest_hours: +pick("rest_hours"),
    notes: pick("notes").replace(/\n/g," ").slice(0, 1000),

    // è¿½åŠ : LIFFæƒ…å ±ï¼ˆn8nã§ user_id ç´ä»˜ã‘ã«ä½¿ãˆã‚‹ï¼‰
    liff: {
      isInClient: LINE_CONTEXT.isInClient,
      isLoggedIn: LINE_CONTEXT.isLoggedIn,
      userId: LINE_CONTEXT.userId,
      displayName: LINE_CONTEXT.displayName,
    }
  };
}

/** ====== ä¿å­˜å‡¦ç† ====== */
async function saveSheets(){
  const st = document.getElementById("status");
  st.style.display = "block";
  st.textContent = "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é€ä¿¡ä¸­â€¦";

  const body = payload();

  try{
    const res = await fetch(WEBHOOK_URL, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        ...(LINE_CONTEXT.idToken ? { "Authorization": `Bearer ${LINE_CONTEXT.idToken}` } : {}),
        "x-liff-user-id": LINE_CONTEXT.userId || "",
        "x-liff-client": LINE_CONTEXT.isInClient ? "1" : "0",
      },
      body: JSON.stringify(body)
    });
    if(!res.ok){ throw new Error("HTTP "+res.status); }
    await res.text();
    st.innerHTML = `âœ… ä¿å­˜å®Œäº† <span class="ok">OK</span>`;

    if (liff.isInClient && liff.sendMessages) {
      try {
        await liff.sendMessages([{ type: "text", text: `ä¿å­˜ã—ã¾ã—ãŸï¼š${body.date}` }]);
      } catch (_) {}
    }
  }catch(e){
    st.innerHTML = `âš ï¸ ä¿å­˜å¤±æ•— <span class="err">${e.message}</span><div class="hint">n8n Webhook / LIFFè¨­å®šï¼ˆprofile/openidï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>`;
  }
}

/** ====== CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ====== */
function exportCSV(){
  const headers = ["date","sleep_hours","energy","satisfaction","focus","stress","social","out_hours","phone_hours","exercise","condition","event","productive_hours","rest_hours","notes","userId"];
  const p = payload();
  const line = headers.map(h => (h==="userId" ? (LINE_CONTEXT.userId||"") : p[h])).join(",");
  const csv = headers.join(",") + "\n" + line;
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `habit_${p.date}.csv`;
  a.click();
}

/** ====== åˆæœŸåŒ– ====== */
document.getElementById("date").value = todayJST();
["energy","focus","satisfaction","stress","condition","exercise","social","sleep_hours","phone_hours","out_hours","productive_hours","rest_hours"].forEach(sync);
initLiff();
</script>
</body>
</html>




